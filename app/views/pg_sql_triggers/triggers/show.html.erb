<!-- Breadcrumb Navigation -->
<div style="margin-bottom: 1rem; color: #6c757d; font-size: 0.875rem;">
  <%= link_to "Dashboard", dashboard_path, style: "color: #007bff; text-decoration: none;" %> /
  <%= link_to "Tables", tables_path, style: "color: #007bff; text-decoration: none;" %> /
  <%= link_to @trigger.table_name, table_path(@trigger.table_name), style: "color: #007bff; text-decoration: none;" %> /
  <span style="color: #495057; font-weight: 600;"><%= @trigger.trigger_name %></span>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h2 style="margin: 0;">Trigger Details: <%= @trigger.trigger_name %></h2>
  <div style="display: flex; gap: 0.5rem;">
    <%= link_to "← Back to Dashboard", dashboard_path, class: "btn", style: "background: #6c757d; color: white; text-decoration: none; padding: 0.5rem 1rem;" %>
    <%= link_to "View Table", table_path(@trigger.table_name), class: "btn", style: "background: #007bff; color: white; text-decoration: none; padding: 0.5rem 1rem;" %>
  </div>
</div>

<!-- Drift Warning -->
<% if @drift_info[:has_drift] %>
  <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem;">
    <h3 style="margin-top: 0; color: #856404;">⚠ Drift Detected</h3>
    <p style="color: #856404; margin-bottom: 0;">
      This trigger has drifted from its expected state. Type: <strong><%= @drift_info[:drift_type] %></strong>
    </p>
  </div>
<% end %>

<!-- Trigger Summary -->
<div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
  <h3 style="margin-top: 0;">Summary</h3>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
    <div>
      <div style="color: #6c757d; font-size: 0.875rem; margin-bottom: 0.25rem;">Status</div>
      <div>
        <% if @trigger.enabled %>
          <span class="badge badge-success">Enabled</span>
        <% else %>
          <span class="badge badge-danger">Disabled</span>
        <% end %>
      </div>
    </div>

    <div>
      <div style="color: #6c757d; font-size: 0.875rem; margin-bottom: 0.25rem;">Table</div>
      <div><strong><%= @trigger.table_name %></strong></div>
    </div>

    <div>
      <div style="color: #6c757d; font-size: 0.875rem; margin-bottom: 0.25rem;">Version</div>
      <div><strong><%= @trigger.version %></strong></div>
    </div>

    <div>
      <div style="color: #6c757d; font-size: 0.875rem; margin-bottom: 0.25rem;">Source</div>
      <div><span class="badge badge-info"><%= @trigger.source %></span></div>
    </div>
  </div>

  <% if @trigger.environment.present? %>
    <div style="margin-bottom: 1rem;">
      <div style="color: #6c757d; font-size: 0.875rem; margin-bottom: 0.25rem;">Environment</div>
      <div><strong><%= @trigger.environment %></strong></div>
    </div>
  <% end %>

  <% if @trigger.installed_at.present? %>
    <div style="margin-bottom: 1rem;">
      <div style="color: #6c757d; font-size: 0.875rem; margin-bottom: 0.25rem;">Last Applied</div>
      <div title="<%= @trigger.installed_at.strftime("%Y-%m-%d %H:%M:%S %Z") %>">
        <%= distance_of_time_in_words_to_now(@trigger.installed_at) %> ago
        <small style="color: #6c757d;">(<%= @trigger.installed_at.strftime("%Y-%m-%d %H:%M:%S") %>)</small>
      </div>
    </div>
  <% end %>

  <% if @trigger.last_verified_at.present? %>
    <div style="margin-bottom: 1rem;">
      <div style="color: #6c757d; font-size: 0.875rem; margin-bottom: 0.25rem;">Last Verified</div>
      <div><%= @trigger.last_verified_at.strftime("%Y-%m-%d %H:%M:%S %Z") %></div>
    </div>
  <% end %>

  <div>
    <div style="color: #6c757d; font-size: 0.875rem; margin-bottom: 0.25rem;">Created At</div>
    <div><%= @trigger.created_at.strftime("%Y-%m-%d %H:%M:%S %Z") %></div>
  </div>
</div>

<!-- Trigger Definition -->
<% if @trigger.definition.present? %>
  <% definition = JSON.parse(@trigger.definition) rescue {} %>
  <div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
    <h3 style="margin-top: 0;">Trigger Configuration</h3>

    <div style="margin-bottom: 1rem;">
      <strong>Function:</strong>
      <code style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 2px;"><%= definition["function_name"] || "N/A" %></code>
    </div>

    <% if definition["timing"].present? %>
      <div style="margin-bottom: 1rem;">
        <strong>Timing:</strong>
        <span class="badge badge-info"><%= definition["timing"].upcase %></span>
      </div>
    <% end %>

    <% if definition["events"].present? %>
      <div style="margin-bottom: 1rem;">
        <strong>Events:</strong>
        <% definition["events"].each do |event| %>
          <span class="badge badge-info" style="margin-left: 0.25rem;"><%= event.upcase %></span>
        <% end %>
      </div>
    <% end %>

    <% if definition["condition"].present? %>
      <div style="margin-bottom: 1rem;">
        <strong>Condition (WHEN):</strong>
        <pre style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; overflow-x: auto;"><code><%= definition["condition"] %></code></pre>
      </div>
    <% end %>

    <% if definition["environments"].present? %>
      <div>
        <strong>Environments:</strong>
        <% definition["environments"].each do |env| %>
          <span class="badge badge-secondary" style="margin-left: 0.25rem;"><%= env %></span>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<!-- SQL Diff (if drift detected) -->
<% if @drift_info[:has_drift] && @drift_info[:expected_sql].present? %>
  <div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
    <h3 style="margin-top: 0;">SQL Drift Comparison</h3>

    <div style="margin-bottom: 1.5rem;">
      <h4 style="color: #28a745; margin-bottom: 0.5rem;">Expected SQL (from DSL)</h4>
      <pre style="background: #d4edda; padding: 1rem; border-radius: 4px; overflow-x: auto; border: 1px solid #c3e6cb;"><code><%= @drift_info[:expected_sql] %></code></pre>
    </div>

    <div>
      <h4 style="color: #dc3545; margin-bottom: 0.5rem;">Actual SQL (from database)</h4>
      <pre style="background: #f8d7da; padding: 1rem; border-radius: 4px; overflow-x: auto; border: 1px solid #f5c6cb;"><code><%= @drift_info[:actual_sql] || "Not found in database" %></code></pre>
    </div>
  </div>
<% end %>

<!-- Function Body -->
<% if @trigger.function_body.present? %>
  <div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
    <h3 style="margin-top: 0;">Function Body</h3>
    <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow-x: auto;"><code><%= @trigger.function_body %></code></pre>
  </div>
<% end %>

<!-- Action Buttons -->
<% if PgSqlTriggers::Permissions.can?(current_actor, :enable_trigger) %>
  <div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0;">Actions</h3>

    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <% if @trigger.enabled %>
        <% form_id = "trigger-detail-disable-form" %>
        <%= form_with url: disable_trigger_path(@trigger), method: :post, local: true, id: form_id, style: "margin: 0;" do |f| %>
          <%= f.hidden_field :redirect_to, value: trigger_path(@trigger) %>
          <button type="button" onclick="showKillSwitchModal('<%= form_id %>')"
              style="padding: 0.75rem 1.5rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
            Disable Trigger
          </button>
        <% end %>
        <%= render 'pg_sql_triggers/shared/confirmation_modal',
                   operation: :ui_trigger_disable,
                   form_id: form_id,
                   title: 'Disable Trigger',
                   message: "Are you sure you want to disable trigger '#{@trigger.trigger_name}'?" %>
      <% else %>
        <% form_id = "trigger-detail-enable-form" %>
        <%= form_with url: enable_trigger_path(@trigger), method: :post, local: true, id: form_id, style: "margin: 0;" do |f| %>
          <%= f.hidden_field :redirect_to, value: trigger_path(@trigger) %>
          <button type="button" onclick="showKillSwitchModal('<%= form_id %>')"
              style="padding: 0.75rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
            Enable Trigger
          </button>
        <% end %>
        <%= render 'pg_sql_triggers/shared/confirmation_modal',
                   operation: :ui_trigger_enable,
                   form_id: form_id,
                   title: 'Enable Trigger',
                   message: "Are you sure you want to enable trigger '#{@trigger.trigger_name}'?" %>
      <% end %>

      <!-- Re-execute button (for drifted triggers) -->
      <% if @drift_info[:has_drift] && PgSqlTriggers::Permissions.can?(current_actor, :drop_trigger) %>
        <%= render 'pg_sql_triggers/triggers/re_execute_modal', trigger: @trigger, drift_info: @drift_info %>
      <% end %>

      <!-- Drop button (Admin only) -->
      <% if PgSqlTriggers::Permissions.can?(current_actor, :drop_trigger) %>
        <%= render 'pg_sql_triggers/triggers/drop_modal', trigger: @trigger %>
      <% end %>
    </div>
  </div>
<% end %>
