<% form_id = "trigger-re-execute-#{trigger.id}-form" %>

<%= form_with url: re_execute_trigger_path(trigger), method: :post, local: true, id: form_id, style: "margin: 0; display: inline-block;" do |f| %>
  <%= f.hidden_field :redirect_to, value: params[:redirect_to] || trigger_path(trigger) %>

  <button type="button" onclick="showReExecuteModal('<%= form_id %>')"
      style="padding: 0.75rem 1.5rem; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
    Re-Execute Trigger
  </button>
<% end %>

<!-- Re-Execute Modal -->
<div id="<%= form_id %>-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div style="background-color: #fefefe; margin: 3% auto; padding: 0; border-radius: 8px; width: 90%; max-width: 800px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <!-- Header -->
    <div style="background: #ffc107; color: #000; padding: 1.5rem; border-radius: 8px 8px 0 0;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">ðŸ”„ Re-Execute Trigger</h3>
        <button type="button" onclick="closeReExecuteModal('<%= form_id %>')"
            style="background: none; border: none; color: #000; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">
          &times;
        </button>
      </div>
    </div>

    <!-- Body -->
    <div style="padding: 1.5rem;">
      <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin-bottom: 1.5rem;">
        <strong style="color: #856404;">Notice:</strong>
        <p style="margin: 0.5rem 0 0 0; color: #856404;">
          This will drop and re-create trigger '<strong><%= trigger.trigger_name %></strong>' based on the expected definition from the registry.
          This can fix drift issues.
        </p>
      </div>

      <!-- Show Drift Diff -->
      <% if drift_info[:expected_sql].present? %>
        <div style="margin-bottom: 1.5rem;">
          <h4 style="margin-bottom: 1rem;">SQL Comparison</h4>

          <div style="margin-bottom: 1rem;">
            <div style="color: #28a745; font-weight: 600; margin-bottom: 0.5rem;">âœ“ Expected SQL (will be applied):</div>
            <pre style="background: #d4edda; padding: 1rem; border-radius: 4px; overflow-x: auto; border: 1px solid #c3e6cb; font-size: 0.85rem; max-height: 200px;"><code><%= drift_info[:expected_sql] %></code></pre>
          </div>

          <div>
            <div style="color: #dc3545; font-weight: 600; margin-bottom: 0.5rem;">âœ— Current SQL (will be replaced):</div>
            <pre style="background: #f8d7da; padding: 1rem; border-radius: 4px; overflow-x: auto; border: 1px solid #f5c6cb; font-size: 0.85rem; max-height: 200px;"><code><%= drift_info[:actual_sql] || "Not found in database" %></code></pre>
          </div>
        </div>
      <% end %>

      <form id="<%= form_id %>-reason-form">
        <div style="margin-bottom: 1rem;">
          <label for="<%= form_id %>-reason" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
            Reason <span style="color: #dc3545;">*</span>
          </label>
          <textarea id="<%= form_id %>-reason" name="reason" required rows="2"
              placeholder="Why are you re-executing this trigger? This will be logged."
              style="width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px; font-family: inherit;"></textarea>
        </div>

        <% if kill_switch_active? %>
          <div style="margin-bottom: 1rem;">
            <label for="<%= form_id %>-confirmation" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
              Confirmation Text <span style="color: #dc3545;">*</span>
            </label>
            <input type="text" id="<%= form_id %>-confirmation" name="confirmation_text" required
                placeholder="<%= expected_confirmation_text(:trigger_re_execute) %>"
                autocomplete="off"
                style="width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace;">
            <small style="color: #6c757d; display: block; margin-top: 0.25rem;">
              Type: <code><%= expected_confirmation_text(:trigger_re_execute) %></code>
            </small>
          </div>
        <% end %>

        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
          <button type="button" onclick="closeReExecuteModal('<%= form_id %>')"
              style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Cancel
          </button>
          <button type="button" onclick="submitReExecute('<%= form_id %>')"
              style="padding: 0.75rem 1.5rem; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
            Re-Execute Trigger
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function showReExecuteModal(formId) {
  document.getElementById(formId + '-modal').style.display = 'block';
}

function closeReExecuteModal(formId) {
  document.getElementById(formId + '-modal').style.display = 'none';
}

function submitReExecute(formId) {
  const form = document.getElementById(formId);
  const reasonForm = document.getElementById(formId + '-reason-form');
  const reason = document.getElementById(formId + '-reason').value;

  if (!reason.trim()) {
    alert('Please provide a reason for re-executing this trigger.');
    return;
  }

  <% if kill_switch_active? %>
    const confirmation = document.getElementById(formId + '-confirmation').value;
    if (!confirmation.trim()) {
      alert('Please provide the confirmation text.');
      return;
    }

    // Add confirmation to main form
    const confirmationInput = document.createElement('input');
    confirmationInput.type = 'hidden';
    confirmationInput.name = 'confirmation_text';
    confirmationInput.value = confirmation;
    form.appendChild(confirmationInput);
  <% end %>

  // Add reason to main form
  const reasonInput = document.createElement('input');
  reasonInput.type = 'hidden';
  reasonInput.name = 'reason';
  reasonInput.value = reason;
  form.appendChild(reasonInput);

  form.submit();
}
</script>
