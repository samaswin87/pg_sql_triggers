<h2>Generate New Trigger</h2>

<p style="color: #6c757d; margin-bottom: 2rem;">
  Create a new PostgreSQL trigger using the form-based wizard.
  Generated triggers are <strong>enabled by default</strong>.
</p>

<%= form_with model: @form, url: preview_generator_index_path, method: :post,
              scope: :pg_sql_triggers_generator_form,
              id: "trigger-generator-form",
              html: { style: "background: white; padding: 2rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);", onsubmit: "return validateForm();" } do |f| %>

  <!-- Section 1: Basic Information -->
  <fieldset style="border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
    <legend style="font-weight: 600; color: #495057; padding: 0 0.5rem;">Basic Information</legend>

    <div style="margin-bottom: 1rem;">
      <%= f.label :trigger_name, "Trigger Name *", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%= f.text_field :trigger_name,
          placeholder: "e.g., users_email_validation",
          required: true,
          style: "width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;" %>
      <small style="color: #6c757d;">Lowercase, underscores only</small>
      <% if @form.errors[:trigger_name].any? %>
        <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:trigger_name].first %></div>
      <% end %>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :table_name, "Table Name *", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <div style="display: flex; gap: 0.5rem; align-items: start;">
        <%= f.select :table_name,
            options_for_select(@available_tables.map { |t| [t, t] }, @form.table_name),
            { include_blank: "Select a table..." },
            {
              required: true,
              id: "table-name-select",
              style: "flex: 1; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;"
            } %>
        <%= link_to "Browse Tables", tables_path, target: "_blank", class: "btn btn-primary", style: "padding: 0.5rem 1rem; white-space: nowrap; text-decoration: none;" %>
      </div>
      <div id="table-validation-message" style="margin-top: 0.25rem;"></div>
      <div id="table-triggers-info" style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; display: none;">
        <strong style="color: #495057;">Existing Triggers:</strong>
        <div id="table-triggers-list" style="margin-top: 0.5rem;"></div>
      </div>
      <% if @form.errors[:table_name].any? %>
        <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:table_name].first %></div>
      <% end %>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :function_name, "Function Name *", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%= f.text_field :function_name,
          placeholder: "e.g., validate_user_email",
          required: true,
          id: "function-name-input",
          style: "width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;" %>
      <small style="color: #6c757d;">The PL/pgSQL function to invoke</small>
      <% if @form.errors[:function_name].any? %>
        <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:function_name].first %></div>
      <% end %>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :function_body, "Function Body *", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%
        default_function_body = @form.function_body.presence || @form.default_function_body
      %>
      <%= f.text_area :function_body,
          value: default_function_body,
          placeholder: "CREATE OR REPLACE FUNCTION #{@form.function_name || 'function_name'}()\nRETURNS TRIGGER AS $$\nBEGIN\n  -- Your trigger logic here\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;",
          required: true,
          id: "function-body-textarea",
          rows: 12,
          style: "width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace; font-size: 0.875rem; line-height: 1.5; resize: vertical;" %>
      <small style="color: #6c757d;">
        Provide the complete PL/pgSQL function definition (BEGIN...END block).
      </small>
      <% if @form.errors[:function_body].any? %>
        <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:function_body].first %></div>
      <% end %>
    </div>
  </fieldset>

  <!-- Section 2: Trigger Events -->
  <fieldset style="border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
    <legend style="font-weight: 600; color: #495057; padding: 0 0.5rem;">Trigger Events *</legend>

    <div style="margin-bottom: 1rem;">
      <%= f.label :timing, "Trigger Timing *", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%= f.select :timing,
          options_for_select([["Before", "before"], ["After", "after"]], @form.timing || "before"),
          {},
          {
            required: true,
            style: "width: 200px; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;"
          } %>
      <small style="color: #6c757d; display: block; margin-top: 0.25rem;">
        When the trigger should fire: BEFORE (before constraint checks) or AFTER (after constraint checks)
      </small>
      <% if @form.errors[:timing].any? %>
        <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:timing].first %></div>
      <% end %>
    </div>

    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <% %w[insert update delete truncate].each do |event| %>
        <label style="display: flex; align-items: center; cursor: pointer;">
          <%= check_box_tag "pg_sql_triggers_generator_form[events][]", event, Array(@form.events).include?(event), id: "events_#{event}" %>
          <span style="margin-left: 0.25rem; text-transform: uppercase;"><%= event %></span>
        </label>
      <% end %>
    </div>
    <small style="color: #6c757d; display: block; margin-top: 0.5rem;">
      Select one or more events that will trigger the function
    </small>
    <% if @form.errors[:events].any? %>
      <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:events].first %></div>
    <% end %>
  </fieldset>

  <!-- Section 3: Configuration -->
  <fieldset style="border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
    <legend style="font-weight: 600; color: #495057; padding: 0 0.5rem;">Configuration</legend>

    <div style="margin-bottom: 1rem;">
      <%= f.label :version, "Version", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%= f.number_field :version, value: @form.version || 1, min: 1,
          style: "width: 100px; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;" %>
      <small style="color: #6c757d; display: block; margin-top: 0.25rem;">
        Default: 1 (increment for future changes)
      </small>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :environments, "Target Environments", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <% %w[development test staging production].each do |env| %>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <%= check_box_tag "pg_sql_triggers_generator_form[environments][]", env, Array(@form.environments).include?(env), id: "environments_#{env}" %>
            <span style="margin-left: 0.25rem;"><%= env.titleize %></span>
          </label>
        <% end %>
      </div>
      <small style="color: #6c757d; display: block; margin-top: 0.5rem;">
        Leave empty to apply to all environments
      </small>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :condition, "WHEN Condition (Optional)", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%= f.text_area :condition,
          placeholder: "e.g., NEW.email IS NOT NULL",
          rows: 2,
          style: "width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace;" %>
      <small style="color: #6c757d;">
        Optional SQL condition for trigger firing
      </small>
    </div>

    <div style="margin-bottom: 1rem;">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <%= f.check_box :enabled, checked: @form.enabled %>
        <span style="margin-left: 0.25rem; font-weight: 500;">Enable trigger after creation</span>
      </label>
      <small style="color: #6c757d; display: block; margin-left: 1.5rem;">
        Trigger will be enabled by default. Uncheck to create disabled.
      </small>
    </div>

    <div style="margin-bottom: 1rem;">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <%= f.check_box :generate_function_stub, checked: @form.generate_function_stub %>
        <span style="margin-left: 0.25rem; font-weight: 500;">Generate PL/pgSQL function stub</span>
      </label>
      <small style="color: #6c757d; display: block; margin-left: 1.5rem;">
        Creates a template function file you can customize
      </small>
    </div>
  </fieldset>

  <!-- Actions -->
  <div style="display: flex; gap: 1rem;">
    <%= f.submit "Preview Generated Code", class: "btn btn-primary" %>
    <%= link_to "Cancel", root_path, class: "btn", style: "background: #6c757d; color: white; text-decoration: none;" %>
  </div>
<% end %>

<script>
// Client-side form validation
function validateForm() {
  const form = document.getElementById('trigger-generator-form');
  if (!form) return true;

  let isValid = true;
  const errors = [];

  // Validate trigger name
  const triggerName = form.querySelector('[name="pg_sql_triggers_generator_form[trigger_name]"]')?.value?.trim();
  if (!triggerName) {
    errors.push('Trigger name is required');
    isValid = false;
  } else if (!/^[a-z0-9_]+$/.test(triggerName)) {
    errors.push('Trigger name must contain only lowercase letters, numbers, and underscores');
    isValid = false;
  }

  // Validate table name
  const tableName = form.querySelector('[name="pg_sql_triggers_generator_form[table_name]"]')?.value?.trim();
  if (!tableName) {
    errors.push('Table name is required');
    isValid = false;
  }

  // Validate function name
  const functionName = form.querySelector('[name="pg_sql_triggers_generator_form[function_name]"]')?.value?.trim();
  if (!functionName) {
    errors.push('Function name is required');
    isValid = false;
  } else if (!/^[a-z0-9_]+$/.test(functionName)) {
    errors.push('Function name must contain only lowercase letters, numbers, and underscores');
    isValid = false;
  }

  // Validate function body
  const functionBody = form.querySelector('[name="pg_sql_triggers_generator_form[function_body]"]')?.value?.trim();
  if (!functionBody) {
    errors.push('Function body is required');
    isValid = false;
  } else if (functionName && !functionBody.match(new RegExp('CREATE\\s+(?:OR\\s+REPLACE\\s+)?FUNCTION\\s+(?:[^\\s(]+\\.)?' + functionName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*\\(', 'i'))) {
    errors.push('Function body should define function \'' + functionName + '\'');
    isValid = false;
  }

  // Validate at least one event is selected
  const eventCheckboxes = form.querySelectorAll('[name="pg_sql_triggers_generator_form[events][]"]:checked');
  if (eventCheckboxes.length === 0) {
    errors.push('At least one event must be selected');
    isValid = false;
  }

  // Validate version
  const version = form.querySelector('[name="pg_sql_triggers_generator_form[version]"]')?.value?.trim();
  if (!version) {
    errors.push('Version is required');
    isValid = false;
  } else {
    const versionNum = parseInt(version, 10);
    if (isNaN(versionNum) || versionNum < 1) {
      errors.push('Version must be a positive integer');
      isValid = false;
    }
  }

  // Display errors
  let errorDiv = document.getElementById('form-validation-errors');
  if (!errorDiv) {
    errorDiv = document.createElement('div');
    errorDiv.id = 'form-validation-errors';
    errorDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px;';
    form.insertBefore(errorDiv, form.firstChild);
  }

  if (!isValid) {
    errorDiv.innerHTML = '<strong style="color: #721c24;">Please fix the following errors:</strong><ul style="margin: 0.5rem 0 0 1.5rem; padding: 0; color: #721c24;"><li>' + errors.join('</li><li>') + '</li></ul>';
    errorDiv.style.display = 'block';
    // Scroll to top of form
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  } else {
    errorDiv.style.display = 'none';
  }

  return isValid;
}

// Generate function body template
function generateFunctionBody(functionName) {
  return 'CREATE OR REPLACE FUNCTION ' + (functionName || 'function_name') + '()\n' +
         'RETURNS TRIGGER AS $$\n' +
         'BEGIN\n' +
         '  -- Your trigger logic here\n' +
         '  RETURN NEW;\n' +
         'END;\n' +
         '$$ LANGUAGE plpgsql;';
}

// Check if textarea value matches the template pattern (so we know it's still the default)
function isTemplateValue(value) {
  if (!value || value.trim() === '') return true;
  // Check if it matches the template pattern
  const templatePattern = /^CREATE\s+(?:OR\s+REPLACE\s+)?FUNCTION\s+\w+\(\)\s+RETURNS\s+TRIGGER/i;
  return templatePattern.test(value.trim());
}

// Update function body value and placeholder when function name changes
document.getElementById('function-name-input')?.addEventListener('input', function(e) {
  const functionName = e.target.value || 'function_name';
  const functionBodyTextarea = document.getElementById('function-body-textarea');
  if (functionBodyTextarea) {
    const newTemplate = generateFunctionBody(functionName);

    // Update placeholder
    functionBodyTextarea.placeholder = newTemplate;

    // Update value only if textarea is empty or matches template pattern
    if (!functionBodyTextarea.value || isTemplateValue(functionBodyTextarea.value)) {
      functionBodyTextarea.value = newTemplate;
    }
  }
});

// Client-side validation for table selection
document.getElementById('table-name-select')?.addEventListener('change', function(e) {
  const tableName = e.target.value;
  const messageDiv = document.getElementById('table-validation-message');
  const infoDiv = document.getElementById('table-triggers-info');
  const triggersList = document.getElementById('table-triggers-list');

  if (!tableName) {
    messageDiv.innerHTML = '';
    if (infoDiv) infoDiv.style.display = 'none';
    return;
  }

  messageDiv.innerHTML = '<span style="color: #6c757d;">Validating...</span>';

  fetch('<%= validate_table_generator_index_path %>', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    },
    body: JSON.stringify({ table_name: tableName })
  })
  .then(response => response.json())
  .then(data => {
    if (data.valid) {
      messageDiv.innerHTML = '<span style="color: #28a745;">✓ Table exists (' + data.column_count + ' columns)</span>';

      // Try to fetch existing triggers for this table
      if (infoDiv && triggersList) {
        fetch('<%= tables_path %>/' + encodeURIComponent(tableName) + '.json', {
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.registry_triggers && data.registry_triggers.length > 0) {
            let triggersHtml = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
            data.registry_triggers.forEach(trigger => {
              triggersHtml += '<div style="padding: 0.5rem; background: white; border-radius: 4px; border-left: 3px solid #007bff;">';
              triggersHtml += '<strong>' + trigger.trigger_name + '</strong> ';
              triggersHtml += '<span class="badge ' + (trigger.enabled ? 'badge-success' : 'badge-danger') + '" style="font-size: 0.75rem;">' + (trigger.enabled ? 'Enabled' : 'Disabled') + '</span>';
              if (trigger.function_name) {
                triggersHtml += '<br><small style="color: #6c757d;">Function: <code>' + trigger.function_name + '</code></small>';
              }
              triggersHtml += '</div>';
            });
            triggersHtml += '</div>';
            triggersHtml += '<div style="margin-top: 0.5rem;"><a href="<%= tables_path %>/' + encodeURIComponent(tableName) + '" target="_blank" style="color: #007bff; text-decoration: none; font-size: 0.875rem;">View all table details →</a></div>';
            triggersList.innerHTML = triggersHtml;
            infoDiv.style.display = 'block';
          } else {
            infoDiv.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Failed to fetch triggers:', error);
          // Fallback: show link to view table details
          triggersList.innerHTML = '<a href="<%= tables_path %>/' + encodeURIComponent(tableName) + '" target="_blank" style="color: #007bff; text-decoration: none;">View table details →</a>';
          infoDiv.style.display = 'block';
        });
      }
    } else {
      messageDiv.innerHTML = '<span style="color: #dc3545;">✗ Table not found in database</span>';
      if (infoDiv) infoDiv.style.display = 'none';
    }
  })
  .catch(error => {
    messageDiv.innerHTML = '<span style="color: #856404;">⚠ Validation unavailable</span>';
    if (infoDiv) infoDiv.style.display = 'none';
  });
});
</script>
