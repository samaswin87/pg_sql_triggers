<div style="max-width: 900px; margin: 0 auto;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2 style="margin: 0;">SQL Capsule: <%= @capsule.name %></h2>
    <%= link_to "← Back to Dashboard", dashboard_path, style: "color: #007bff; text-decoration: none;" %>
  </div>

  <div style="background: white; padding: 2rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
    <h3 style="margin-top: 0; margin-bottom: 1rem; color: #495057;">Capsule Details</h3>

    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem; margin-bottom: 1rem;">
      <div style="font-weight: 600; color: #6c757d;">Name:</div>
      <div><%= @capsule.name %></div>

      <div style="font-weight: 600; color: #6c757d;">Environment:</div>
      <div><span class="badge badge-info"><%= @capsule.environment %></span></div>

      <div style="font-weight: 600; color: #6c757d;">Created:</div>
      <div><%= @capsule.created_at.strftime("%Y-%m-%d %H:%M:%S %Z") %></div>

      <div style="font-weight: 600; color: #6c757d;">Checksum:</div>
      <div style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 0.85rem; color: #6c757d;">
        <%= @checksum %>
      </div>
    </div>

    <div style="margin-top: 1.5rem;">
      <div style="font-weight: 600; color: #6c757d; margin-bottom: 0.5rem;">Purpose:</div>
      <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; border-left: 3px solid #007bff;">
        <%= @capsule.purpose %>
      </div>
    </div>

    <div style="margin-top: 1.5rem;">
      <div style="font-weight: 600; color: #6c757d; margin-bottom: 0.5rem;">SQL Statement:</div>
      <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; border-left: 3px solid #28a745; overflow-x: auto;">
        <pre style="margin: 0; font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 0.9rem; white-space: pre-wrap; word-wrap: break-word;"><%= @capsule.sql %></pre>
      </div>
    </div>
  </div>

  <% if @can_execute %>
    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem;">
      <h4 style="margin-top: 0; color: #856404;">⚠️ Execution Warning</h4>
      <p style="margin-bottom: 1rem; color: #856404;">
        This will execute the SQL statement directly against the database.
        This operation cannot be undone. Make sure you understand the implications.
      </p>

      <% if kill_switch_active? %>
        <p style="margin-bottom: 1rem; color: #856404;">
          <strong>Kill Switch is ACTIVE for <%= current_environment %> environment.</strong><br>
          You must provide confirmation text to proceed.
        </p>
      <% end %>

      <% form_id = "execute-capsule-form" %>
      <%= form_with url: execute_sql_capsule_path(@capsule.name), method: :post, local: true, id: form_id do |f| %>
        <div style="display: flex; gap: 1rem; align-items: flex-end;">
          <div style="flex: 1;">
            <button type="button" onclick="showKillSwitchModal('<%= form_id %>')"
                style="width: 100%; padding: 0.75rem 1.5rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600;">
              Execute SQL Capsule
            </button>
          </div>
        </div>
      <% end %>

      <%= render 'pg_sql_triggers/shared/confirmation_modal',
                 operation: :execute_sql_capsule,
                 form_id: form_id,
                 title: 'Execute SQL Capsule',
                 message: "Are you sure you want to execute SQL capsule '#{@capsule.name}'? This will run the SQL statement directly against the database." %>
    </div>
  <% else %>
    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 1rem; border-radius: 4px; color: #721c24;">
      <strong>Insufficient Permissions:</strong> You need Admin role to execute SQL capsules.
    </div>
  <% end %>

  <div style="margin-top: 2rem;">
    <%= link_to "Create Another Capsule", new_sql_capsule_path,
        class: "btn btn-primary",
        style: "padding: 0.75rem 1.5rem; background: #007bff; color: white; text-decoration: none; border-radius: 4px; display: inline-block;" %>
  </div>
</div>
