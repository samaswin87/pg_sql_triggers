<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h2 style="margin: 0;">Trigger Dashboard</h2>
  <div style="display: flex; gap: 1rem;">
    <%= link_to "View Tables", tables_path, class: "btn btn-primary", style: "font-size: 1rem; padding: 0.75rem 1.5rem; text-decoration: none;" %>
    <%= link_to "Generate New Trigger", new_generator_path,
        class: "btn btn-success",
        style: "font-size: 1rem; padding: 0.75rem 1.5rem; text-decoration: none;" %>
  </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
  <div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div style="font-size: 2rem; font-weight: 600; color: #007bff;"><%= @stats[:total] %></div>
    <div style="color: #6c757d;">Total Triggers</div>
  </div>

  <div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div style="font-size: 2rem; font-weight: 600; color: #28a745;"><%= @stats[:enabled] %></div>
    <div style="color: #6c757d;">Enabled</div>
  </div>

  <div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div style="font-size: 2rem; font-weight: 600; color: #6c757d;"><%= @stats[:disabled] %></div>
    <div style="color: #6c757d;">Disabled</div>
  </div>

  <div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <div style="font-size: 2rem; font-weight: 600; color: #ffc107;"><%= @stats[:drifted] %></div>
    <div style="color: #6c757d;">Drifted</div>
  </div>
</div>

<% if @triggers.any? %>
  <h3>Recent Triggers</h3>
  <table>
    <thead>
      <tr>
        <th>Trigger Name</th>
        <th>Table</th>
        <th>Version</th>
        <th>Status</th>
        <th>Source</th>
        <th>Last Applied</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @triggers.limit(10).each do |trigger| %>
        <tr>
          <td>
            <%= link_to trigger.trigger_name, trigger_path(trigger), style: "color: #007bff; text-decoration: none; font-weight: 600;" %>
          </td>
          <td><%= trigger.table_name %></td>
          <td><%= trigger.version %></td>
          <td>
            <% if trigger.enabled %>
              <span class="badge badge-success">Enabled</span>
            <% else %>
              <span class="badge badge-danger">Disabled</span>
            <% end %>
          </td>
          <td><span class="badge badge-info"><%= trigger.source %></span></td>
          <td>
            <% if trigger.installed_at.present? %>
              <span title="<%= trigger.installed_at.strftime("%Y-%m-%d %H:%M:%S %Z") %>" style="cursor: help;">
                <%= distance_of_time_in_words_to_now(trigger.installed_at) %> ago
              </span>
            <% else %>
              <span style="color: #6c757d;">Never</span>
            <% end %>
          </td>
          <td>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <% if PgSqlTriggers::Permissions.can?(current_actor, :enable_trigger) %>
                <% if trigger.enabled %>
                  <% form_id = "trigger-disable-#{trigger.id}-form" %>
                  <%= form_with url: disable_trigger_path(trigger), method: :post, local: false, id: form_id, style: "margin: 0;" do |f| %>
                    <%= f.hidden_field :redirect_to, value: dashboard_path %>
                    <button type="button" onclick="showKillSwitchModal('<%= form_id %>')"
                        style="padding: 0.25rem 0.75rem; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">
                      Disable
                    </button>
                  <% end %>
                  <%= render 'pg_sql_triggers/shared/confirmation_modal',
                             operation: :ui_trigger_disable,
                             form_id: form_id,
                             title: 'Disable Trigger',
                             message: "Are you sure you want to disable trigger '#{trigger.trigger_name}'?" %>
                <% else %>
                  <% form_id = "trigger-enable-#{trigger.id}-form" %>
                  <%= form_with url: enable_trigger_path(trigger), method: :post, local: false, id: form_id, style: "margin: 0;" do |f| %>
                    <%= f.hidden_field :redirect_to, value: dashboard_path %>
                    <button type="button" onclick="showKillSwitchModal('<%= form_id %>')"
                        style="padding: 0.25rem 0.75rem; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">
                      Enable
                    </button>
                  <% end %>
                  <%= render 'pg_sql_triggers/shared/confirmation_modal',
                             operation: :ui_trigger_enable,
                             form_id: form_id,
                             title: 'Enable Trigger',
                             message: "Are you sure you want to enable trigger '#{trigger.trigger_name}'?" %>
                <% end %>
              <% end %>

              <% if PgSqlTriggers::Permissions.can?(current_actor, :drop_trigger) %>
                <% begin %>
                  <% drift_info = trigger.drift_result %>
                  <% if drift_info && drift_info[:state] == 'drifted' %>
                    <%= render 'pg_sql_triggers/triggers/re_execute_modal', trigger: trigger, drift_info: drift_info, redirect_to: dashboard_path, button_size: :small %>
                  <% end %>
                <% rescue StandardError %>
                  <% # Skip if drift detection fails %>
                <% end %>

                <%= render 'pg_sql_triggers/triggers/drop_modal', trigger: trigger, redirect_to: dashboard_path, button_size: :small %>
              <% end %>

              <% unless PgSqlTriggers::Permissions.can?(current_actor, :enable_trigger) || PgSqlTriggers::Permissions.can?(current_actor, :drop_trigger) %>
                <span style="color: #6c757d;">—</span>
              <% end %>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <div style="background: #e7f3ff; border-left: 4px solid #007bff; padding: 1.5rem; border-radius: 4px;">
    <h3 style="margin-top: 0;">No triggers yet</h3>
    <p style="margin-bottom: 1rem;">Get started by generating your first trigger using the form-based wizard.</p>
    <%= link_to "Generate New Trigger", new_generator_path, class: "btn btn-primary" %>
  </div>
<% end %>

<!-- Migration Management Section -->
<div style="margin-top: 3rem;">
  <h3>Trigger Migrations</h3>

  <div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
      <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <div style="font-size: 1.5rem; font-weight: 600; color: #007bff;"><%= @total_migrations || 0 %></div>
        <div style="color: #6c757d;">Total Migrations</div>
      </div>
      <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <div style="font-size: 1.5rem; font-weight: 600; color: #28a745;"><%= @migration_status.count { |m| m[:status] == "up" } %></div>
        <div style="color: #6c757d;">Applied</div>
      </div>
      <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <div style="font-size: 1.5rem; font-weight: 600; color: #ffc107;"><%= @pending_migrations.count %></div>
        <div style="color: #6c757d;">Pending</div>
      </div>
      <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <div style="font-size: 1.5rem; font-weight: 600; color: #6c757d;"><%= @current_migration_version %></div>
        <div style="color: #6c757d;">Current Version</div>
      </div>
    </div>

    <!-- Migration Action Buttons -->
    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
      <% if @pending_migrations.any? %>
        <%= form_with url: up_migrations_path, method: :post, local: true, id: "migration-up-all-form", style: "margin: 0;" do |f| %>
          <button type="button" onclick="showKillSwitchModal('migration-up-all-form')"
              style="padding: 0.75rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
            Apply All Pending Migrations
          </button>
        <% end %>
        <%= render 'pg_sql_triggers/shared/confirmation_modal',
                   operation: :ui_migration_up,
                   form_id: 'migration-up-all-form',
                   title: 'Apply All Pending Migrations',
                   message: "Are you sure you want to apply #{@pending_migrations.count} pending migration(s)?" %>
      <% end %>

      <% if @current_migration_version > 0 %>
        <%= form_with url: down_migrations_path, method: :post, local: true, id: "migration-down-form", style: "margin: 0;" do |f| %>
          <button type="button" onclick="showKillSwitchModal('migration-down-form')"
              style="padding: 0.75rem 1.5rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
            Rollback Last Migration
          </button>
        <% end %>
        <%= render 'pg_sql_triggers/shared/confirmation_modal',
                   operation: :ui_migration_down,
                   form_id: 'migration-down-form',
                   title: 'Rollback Last Migration',
                   message: 'Are you sure you want to rollback the last migration?' %>

        <%= form_with url: redo_migrations_path, method: :post, local: true, id: "migration-redo-form", style: "margin: 0;" do |f| %>
          <button type="button" onclick="showKillSwitchModal('migration-redo-form')"
              style="padding: 0.75rem 1.5rem; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
            Redo Last Migration
          </button>
        <% end %>
        <%= render 'pg_sql_triggers/shared/confirmation_modal',
                   operation: :ui_migration_redo,
                   form_id: 'migration-redo-form',
                   title: 'Redo Last Migration',
                   message: 'Are you sure you want to redo the last migration?' %>
      <% end %>
    </div>

    <% if @pending_migrations.any? %>
      <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
        <strong style="color: #856404;">Pending Migrations:</strong>
        <ul style="margin: 0.5rem 0 0 1.5rem; color: #856404;">
          <% @pending_migrations.each do |migration| %>
            <li><code><%= migration.filename %></code></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <% if @total_migrations > 0 %>
      <h4 style="margin-top: 0;">Migration Status</h4>
      <div style="margin-bottom: 1rem; color: #6c757d; font-size: 0.875rem;">
        Showing <%= (@page - 1) * @per_page + 1 %>-<%= [@page * @per_page, @total_migrations].min %> of <%= @total_migrations %> migrations
      </div>
      <table>
        <thead>
          <tr>
            <th>Version</th>
            <th>Name</th>
            <th>Status</th>
            <th>Filename</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @migration_status.each do |migration| %>
            <tr>
              <td><strong><%= migration[:version] %></strong></td>
              <td><%= migration[:name] %></td>
              <td>
                <% if migration[:status] == "up" %>
                  <span class="badge badge-success">Applied</span>
                <% else %>
                  <span class="badge badge-warning">Pending</span>
                <% end %>
              </td>
              <td><code style="font-size: 0.875rem;"><%= migration[:filename] %></code></td>
              <td>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <% if migration[:status] == "down" %>
                    <% form_id = "migration-up-#{migration[:version]}-form" %>
                    <%= form_with url: up_migrations_path, method: :post, local: true, id: form_id, style: "margin: 0;" do |f| %>
                      <%= f.hidden_field :version, value: migration[:version] %>
                      <button type="button" onclick="showKillSwitchModal('<%= form_id %>')"
                          style="padding: 0.25rem 0.75rem; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">
                        Up
                      </button>
                    <% end %>
                    <%= render 'pg_sql_triggers/shared/confirmation_modal',
                               operation: :ui_migration_up,
                               form_id: form_id,
                               title: 'Apply Migration',
                               message: "Are you sure you want to apply migration #{migration[:version]}?" %>
                  <% else %>
                    <% form_id_down = "migration-down-#{migration[:version]}-form" %>
                    <%= form_with url: down_migrations_path, method: :post, local: true, id: form_id_down, style: "margin: 0;" do |f| %>
                      <%= f.hidden_field :version, value: migration[:version] %>
                      <button type="button" onclick="showKillSwitchModal('<%= form_id_down %>')"
                          style="padding: 0.25rem 0.75rem; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">
                        Down
                      </button>
                    <% end %>
                    <%= render 'pg_sql_triggers/shared/confirmation_modal',
                               operation: :ui_migration_down,
                               form_id: form_id_down,
                               title: 'Rollback Migration',
                               message: "Are you sure you want to rollback to version #{migration[:version]}?" %>

                    <% form_id_redo = "migration-redo-#{migration[:version]}-form" %>
                    <%= form_with url: redo_migrations_path, method: :post, local: true, id: form_id_redo, style: "margin: 0;" do |f| %>
                      <%= f.hidden_field :version, value: migration[:version] %>
                      <button type="button" onclick="showKillSwitchModal('<%= form_id_redo %>')"
                          style="padding: 0.25rem 0.75rem; background: #ffc107; color: #212529; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">
                        Redo
                      </button>
                    <% end %>
                    <%= render 'pg_sql_triggers/shared/confirmation_modal',
                               operation: :ui_migration_redo,
                               form_id: form_id_redo,
                               title: 'Redo Migration',
                               message: "Are you sure you want to redo migration #{migration[:version]}?" %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <!-- Pagination Controls -->
      <% if @total_pages > 1 %>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
          <div>
            <% if @page > 1 %>
              <%= link_to "← Previous", dashboard_path(page: @page - 1, per_page: @per_page),
                  style: "padding: 0.5rem 1rem; background: #007bff; color: white; text-decoration: none; border-radius: 4px; margin-right: 0.5rem;" %>
            <% end %>
            <% if @page < @total_pages %>
              <%= link_to "Next →", dashboard_path(page: @page + 1, per_page: @per_page),
                  style: "padding: 0.5rem 1rem; background: #007bff; color: white; text-decoration: none; border-radius: 4px;" %>
            <% end %>
          </div>
          <div style="color: #6c757d; font-size: 0.875rem;">
            Page <%= @page %> of <%= @total_pages %>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <label style="color: #6c757d; font-size: 0.875rem;">Per page:</label>
            <select onchange="window.location.href='<%= dashboard_path %>?page=1&per_page=' + this.value"
                    style="padding: 0.25rem 0.5rem; border: 1px solid #ced4da; border-radius: 4px;">
              <option value="10" <%= 'selected' if @per_page == 10 %>>10</option>
              <option value="20" <%= 'selected' if @per_page == 20 %>>20</option>
              <option value="50" <%= 'selected' if @per_page == 50 %>>50</option>
              <option value="100" <%= 'selected' if @per_page == 100 %>>100</option>
            </select>
          </div>
        </div>
      <% end %>
    <% else %>
      <div style="background: #e7f3ff; border-left: 4px solid #007bff; padding: 1rem; border-radius: 4px;">
        <p style="margin: 0; color: #0c5460;">No trigger migrations found. Migrations should be placed in <code>db/triggers/</code>.</p>
      </div>
    <% end %>
  </div>
</div>
