<div style="margin-bottom: 2rem;">
  <h2>Table: <%= @table_info[:table_name] %></h2>
  <%= link_to "â† Back to Tables", tables_path, class: "btn", style: "background: #6c757d; color: white; text-decoration: none; margin-right: 1rem;" %>
  <%= link_to "Create Trigger for this Table", new_generator_path(pg_sql_triggers_generator_form: { table_name: @table_info[:table_name] }), class: "btn btn-success" %>
</div>

<!-- Table Information -->
<div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
  <h3 style="margin-top: 0;">Table Columns</h3>
  <% if @columns.any? %>
    <table>
      <thead>
        <tr>
          <th>Column Name</th>
          <th>Data Type</th>
          <th>Nullable</th>
        </tr>
      </thead>
      <tbody>
        <% @columns.each do |column| %>
          <tr>
            <td><strong><%= column[:name] %></strong></td>
            <td><code><%= column[:type] %></code></td>
            <td>
              <% if column[:nullable] %>
                <span class="badge badge-warning">Yes</span>
              <% else %>
                <span class="badge badge-success">No</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p style="color: #6c757d;">No columns found.</p>
  <% end %>
</div>

<!-- Registry Triggers -->
<div style="background: white; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
  <h3 style="margin-top: 0;">Registered Triggers</h3>
  <% if @table_info[:registry_triggers].any? %>
    <div style="display: flex; flex-direction: column; gap: 1rem;">
      <% @table_info[:registry_triggers].each do |trigger| %>
        <div style="border: 1px solid #dee2e6; border-radius: 4px; padding: 1rem; background: #f8f9fa;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
              <h4 style="margin: 0;">
                <%= link_to trigger.trigger_name, trigger_path(trigger), style: "color: #007bff; text-decoration: none;" %>
                <% if trigger.enabled %>
                  <span class="badge badge-success">Enabled</span>
                <% else %>
                  <span class="badge badge-danger">Disabled</span>
                <% end %>
              </h4>
              <p style="color: #6c757d; margin: 0.5rem 0 0 0;">
                Version: <strong><%= trigger.version %></strong> |
                Source: <span class="badge badge-info"><%= trigger.source %></span>
                <% if trigger.environment.present? %>
                  | Environment: <strong><%= trigger.environment %></strong>
                <% end %>
              </p>
            </div>
          </div>

          <% if PgSqlTriggers::Permissions.can?(current_actor, :enable_trigger) %>
            <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
              <% if trigger.enabled %>
                <% form_id = "table-trigger-disable-#{trigger.id}-form" %>
                <%= form_with url: disable_trigger_path(trigger), method: :post, local: true, id: form_id, style: "margin: 0;" do |f| %>
                  <%= f.hidden_field :redirect_to, value: table_path(@table_info[:table_name]) %>
                  <button type="button" onclick="showKillSwitchModal('<%= form_id %>')"
                      style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                    Disable Trigger
                  </button>
                <% end %>
                <%= render 'pg_sql_triggers/shared/confirmation_modal',
                           operation: :ui_trigger_disable,
                           form_id: form_id,
                           title: 'Disable Trigger',
                           message: "Are you sure you want to disable trigger '#{trigger.trigger_name}' on table '#{@table_info[:table_name]}'?" %>
              <% else %>
                <% form_id = "table-trigger-enable-#{trigger.id}-form" %>
                <%= form_with url: enable_trigger_path(trigger), method: :post, local: true, id: form_id, style: "margin: 0;" do |f| %>
                  <%= f.hidden_field :redirect_to, value: table_path(@table_info[:table_name]) %>
                  <button type="button" onclick="showKillSwitchModal('<%= form_id %>')"
                      style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                    Enable Trigger
                  </button>
                <% end %>
                <%= render 'pg_sql_triggers/shared/confirmation_modal',
                           operation: :ui_trigger_enable,
                           form_id: form_id,
                           title: 'Enable Trigger',
                           message: "Are you sure you want to enable trigger '#{trigger.trigger_name}' on table '#{@table_info[:table_name]}'?" %>
              <% end %>
            </div>
          <% end %>

          <% if trigger.definition.present? %>
            <% definition = JSON.parse(trigger.definition) rescue {} %>
            <div style="margin-bottom: 1rem;">
              <strong>Function:</strong> <code style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 2px;"><%= definition["function_name"] || "N/A" %></code>
              <% if definition["events"].present? %>
                <span style="margin-left: 1rem;">
                  <strong>Events:</strong>
                  <% definition["events"].each do |event| %>
                    <span class="badge badge-info" style="margin-left: 0.25rem;"><%= event %></span>
                  <% end %>
                </span>
              <% end %>
            </div>
          <% end %>

          <% if trigger.function_body.present? %>
            <details style="margin-top: 1rem;">
              <summary style="cursor: pointer; font-weight: 600; color: #495057;">View Function Body</summary>
              <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; overflow-x: auto;"><code><%= trigger.function_body %></code></pre>
            </details>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div style="background: #e7f3ff; border-left: 4px solid #007bff; padding: 1rem; border-radius: 4px;">
      <p style="margin: 0;">No registered triggers for this table.</p>
      <%= link_to "Create a trigger", new_generator_path(pg_sql_triggers_generator_form: { table_name: @table_info[:table_name] }), class: "btn btn-primary", style: "margin-top: 0.5rem;" %>
    </div>
  <% end %>
</div>

<!-- Database Triggers (not in registry) -->
<% if @table_info[:database_triggers].any? %>
  <div style="background: #fff3cd; padding: 1.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #ffc107;">
    <h3 style="margin-top: 0; color: #856404;">Database Triggers (Not in Registry)</h3>
    <p style="color: #856404; margin-bottom: 1rem;">
      These triggers exist in the database but are not registered in the trigger registry.
      Consider registering them or reviewing their status.
    </p>
    <div style="display: flex; flex-direction: column; gap: 1rem;">
      <% @table_info[:database_triggers].each do |trigger| %>
        <div style="border: 1px solid #ffc107; border-radius: 4px; padding: 1rem; background: white;">
          <h4 style="margin: 0; color: #856404;">
            <%= trigger[:trigger_name] %>
            <span class="badge badge-warning">DB Only</span>
          </h4>
          <p style="color: #6c757d; margin: 0.5rem 0 0 0;">
            Function: <code style="background: #e9ecef; padding: 0.125rem 0.25rem; border-radius: 2px;"><%= trigger[:function_name] %></code>
          </p>
          <details style="margin-top: 0.5rem;">
            <summary style="cursor: pointer; font-weight: 600; color: #495057; font-size: 0.875rem;">View Definition</summary>
            <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; overflow-x: auto; font-size: 0.875rem;"><code><%= trigger[:definition] %></code></pre>
          </details>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
