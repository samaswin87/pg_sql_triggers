<h2>Generate New Trigger</h2>

<p style="color: #6c757d; margin-bottom: 2rem;">
  Create a new PostgreSQL trigger using the form-based wizard.
  Generated triggers are <strong>disabled by default</strong> and must be explicitly enabled.
</p>

<%= form_with model: @form, url: preview_generator_index_path, method: :post,
              scope: :pg_triggers_generator_form,
              id: "trigger-generator-form",
              html: { style: "background: white; padding: 2rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" } do |f| %>

  <!-- Section 1: Basic Information -->
  <fieldset style="border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
    <legend style="font-weight: 600; color: #495057; padding: 0 0.5rem;">Basic Information</legend>

    <div style="margin-bottom: 1rem;">
      <%= f.label :trigger_name, "Trigger Name *", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%= f.text_field :trigger_name,
          placeholder: "e.g., users_email_validation",
          required: true,
          style: "width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;" %>
      <small style="color: #6c757d;">Lowercase, underscores only</small>
      <% if @form.errors[:trigger_name].any? %>
        <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:trigger_name].first %></div>
      <% end %>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :table_name, "Table Name *", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <div style="display: flex; gap: 0.5rem; align-items: start;">
        <%= f.select :table_name,
            options_for_select(@available_tables.map { |t| [t, t] }, @form.table_name),
            { include_blank: "Select a table..." },
            {
              required: true,
              id: "table-name-select",
              style: "flex: 1; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;"
            } %>
        <%= link_to "Browse Tables", tables_path, target: "_blank", class: "btn btn-primary", style: "padding: 0.5rem 1rem; white-space: nowrap; text-decoration: none;" %>
      </div>
      <div id="table-validation-message" style="margin-top: 0.25rem;"></div>
      <div id="table-triggers-info" style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; display: none;">
        <strong style="color: #495057;">Existing Triggers:</strong>
        <div id="table-triggers-list" style="margin-top: 0.5rem;"></div>
      </div>
      <% if @form.errors[:table_name].any? %>
        <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:table_name].first %></div>
      <% end %>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :function_name, "Function Name *", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%= f.text_field :function_name,
          placeholder: "e.g., validate_user_email",
          required: true,
          style: "width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;" %>
      <small style="color: #6c757d;">The PL/pgSQL function to invoke</small>
      <% if @form.errors[:function_name].any? %>
        <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:function_name].first %></div>
      <% end %>
    </div>
  </fieldset>

  <!-- Section 2: Trigger Events -->
  <fieldset style="border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
    <legend style="font-weight: 600; color: #495057; padding: 0 0.5rem;">Trigger Events *</legend>

    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <% %w[insert update delete truncate].each do |event| %>
        <label style="display: flex; align-items: center; cursor: pointer;">
          <%= f.check_box :events, { multiple: true }, event, nil %>
          <span style="margin-left: 0.25rem; text-transform: uppercase;"><%= event %></span>
        </label>
      <% end %>
    </div>
    <small style="color: #6c757d; display: block; margin-top: 0.5rem;">
      Select one or more events that will trigger the function
    </small>
    <% if @form.errors[:events].any? %>
      <div style="color: #dc3545; margin-top: 0.25rem;"><%= @form.errors[:events].first %></div>
    <% end %>
  </fieldset>

  <!-- Section 3: Configuration -->
  <fieldset style="border: 1px solid #dee2e6; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
    <legend style="font-weight: 600; color: #495057; padding: 0 0.5rem;">Configuration</legend>

    <div style="margin-bottom: 1rem;">
      <%= f.label :version, "Version", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%= f.number_field :version, value: @form.version || 1, min: 1,
          style: "width: 100px; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;" %>
      <small style="color: #6c757d; display: block; margin-top: 0.25rem;">
        Default: 1 (increment for future changes)
      </small>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :environments, "Target Environments", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <% %w[development test staging production].each do |env| %>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <%= f.check_box :environments, { multiple: true }, env, nil %>
            <span style="margin-left: 0.25rem;"><%= env.titleize %></span>
          </label>
        <% end %>
      </div>
      <small style="color: #6c757d; display: block; margin-top: 0.5rem;">
        Leave empty to apply to all environments
      </small>
    </div>

    <div style="margin-bottom: 1rem;">
      <%= f.label :condition, "WHEN Condition (Optional)", style: "display: block; font-weight: 500; margin-bottom: 0.25rem;" %>
      <%= f.text_area :condition,
          placeholder: "e.g., NEW.email IS NOT NULL",
          rows: 2,
          style: "width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace;" %>
      <small style="color: #6c757d;">
        Optional SQL condition for trigger firing
      </small>
    </div>

    <div style="margin-bottom: 1rem;">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <%= f.check_box :enabled %>
        <span style="margin-left: 0.25rem; font-weight: 500;">Enable trigger after creation</span>
      </label>
      <small style="color: #6c757d; display: block; margin-left: 1.5rem;">
        Recommended: Leave disabled for testing
      </small>
    </div>

    <div style="margin-bottom: 1rem;">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <%= f.check_box :generate_function_stub, checked: @form.generate_function_stub %>
        <span style="margin-left: 0.25rem; font-weight: 500;">Generate PL/pgSQL function stub</span>
      </label>
      <small style="color: #6c757d; display: block; margin-left: 1.5rem;">
        Creates a template function file you can customize
      </small>
    </div>
  </fieldset>

  <!-- Actions -->
  <div style="display: flex; gap: 1rem;">
    <%= f.submit "Preview Generated Code", class: "btn btn-primary" %>
    <%= link_to "Cancel", root_path, class: "btn", style: "background: #6c757d; color: white; text-decoration: none;" %>
  </div>
<% end %>

<script>
// Client-side validation for table selection
document.getElementById('table-name-select')?.addEventListener('change', function(e) {
  const tableName = e.target.value;
  const messageDiv = document.getElementById('table-validation-message');
  const infoDiv = document.getElementById('table-triggers-info');
  const triggersList = document.getElementById('table-triggers-list');

  if (!tableName) {
    messageDiv.innerHTML = '';
    if (infoDiv) infoDiv.style.display = 'none';
    return;
  }

  messageDiv.innerHTML = '<span style="color: #6c757d;">Validating...</span>';

  fetch('<%= validate_table_generator_index_path %>', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    },
    body: JSON.stringify({ table_name: tableName })
  })
  .then(response => response.json())
  .then(data => {
    if (data.valid) {
      messageDiv.innerHTML = '<span style="color: #28a745;">✓ Table exists (' + data.column_count + ' columns)</span>';
      
      // Try to fetch existing triggers for this table
      if (infoDiv && triggersList) {
        fetch('<%= tables_path %>/' + encodeURIComponent(tableName) + '.json', {
          headers: {
            'Accept': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.registry_triggers && data.registry_triggers.length > 0) {
            let triggersHtml = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
            data.registry_triggers.forEach(trigger => {
              triggersHtml += '<div style="padding: 0.5rem; background: white; border-radius: 4px; border-left: 3px solid #007bff;">';
              triggersHtml += '<strong>' + trigger.trigger_name + '</strong> ';
              triggersHtml += '<span class="badge ' + (trigger.enabled ? 'badge-success' : 'badge-danger') + '" style="font-size: 0.75rem;">' + (trigger.enabled ? 'Enabled' : 'Disabled') + '</span>';
              if (trigger.function_name) {
                triggersHtml += '<br><small style="color: #6c757d;">Function: <code>' + trigger.function_name + '</code></small>';
              }
              triggersHtml += '</div>';
            });
            triggersHtml += '</div>';
            triggersHtml += '<div style="margin-top: 0.5rem;"><a href="<%= tables_path %>/' + encodeURIComponent(tableName) + '" target="_blank" style="color: #007bff; text-decoration: none; font-size: 0.875rem;">View all table details →</a></div>';
            triggersList.innerHTML = triggersHtml;
            infoDiv.style.display = 'block';
          } else {
            infoDiv.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Failed to fetch triggers:', error);
          // Fallback: show link to view table details
          triggersList.innerHTML = '<a href="<%= tables_path %>/' + encodeURIComponent(tableName) + '" target="_blank" style="color: #007bff; text-decoration: none;">View table details →</a>';
          infoDiv.style.display = 'block';
        });
      }
    } else {
      messageDiv.innerHTML = '<span style="color: #dc3545;">✗ Table not found in database</span>';
      if (infoDiv) infoDiv.style.display = 'none';
    }
  })
  .catch(error => {
    messageDiv.innerHTML = '<span style="color: #856404;">⚠ Validation unavailable</span>';
    if (infoDiv) infoDiv.style.display = 'none';
  });
});
</script>
